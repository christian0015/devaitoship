<script>
// Stocker le shopId dans une variable globale
window.DEVAITO_SHOP_ID = '68c94bda80a0b01b112de19e';

(function(){
  // CONFIG
  const API_URL = "https://devaitoship.vercel.app/api/get_shipping_rates";
  const CART_LS_KEY = "cartItems";

  // HELPERS
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $all = (sel, ctx=document) => Array.from((ctx||document).querySelectorAll(sel));
  const safeNum = v => (isNaN(Number(v)) ? 0 : Number(v));
  const formatMoney = v => (typeof v === 'number' && !isNaN(v)) ? v.toFixed(2) + ' ‚Ç¨' : 'N/A';
  
  const parseCartFromStorage = () => {
    try {
      const raw = localStorage.getItem(CART_LS_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch(e){
      console.error('parseCart error', e);
      return [];
    }
  };
  
  const normalizeProductsFromCart = (cart) => {
    const m = new Map();
    cart.forEach(item=>{
      const pid = Number(item.id);
      const qty = Math.max(0, Number(item.quantity) || 0);
      if(!m.has(pid)){
        m.set(pid, {
          productId: pid,
          quantity: qty,
          name: item.name || ('#' + pid),
          image: item.image || '',
          unitPrice: Number(item.unitPrice || item.oldPrice || 0)
        });
      } else {
        m.get(pid).quantity += qty;
      }
    });
    return Array.from(m.values());
  };
  
  function getSelectedCountryText(){
    const sel = $('#country');
    if(!sel) return '';
    const opt = sel.options[sel.selectedIndex];
    return (opt && opt.text) ? opt.text.trim() : (sel.value || '');
  }
  
  function getSelectedStateName(){
    const sel = $('#state');
    if(!sel) return '';
    const opt = sel.options[sel.selectedIndex];
    return (opt && opt.dataset && opt.dataset.name) ? opt.dataset.name : (opt ? opt.text : '');
  }
  
  function getSelectedCityText(){
    const sel = $('#city');
    if(!sel) return '';
    const opt = sel.options[sel.selectedIndex];
    return (opt && opt.text) ? opt.text.trim() : (sel.value || '');
  }

  // UI INJECTION (styles + elements) - CSS AM√âLIOR√â
  const style = document.createElement('style');
  style.textContent = `
  /* FAB Button - Force visibility */
  .devaito-fab { 
    position: fixed !important; 
    right: 20px !important; 
    bottom: 20px !important; 
    width: 60px !important; 
    height: 60px !important; 
    border-radius: 16px !important; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; 
    display: flex !important; 
    align-items: center !important; 
    justify-content: center !important; 
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4), 0 4px 10px rgba(0,0,0,0.1) !important; 
    cursor: pointer !important; 
    z-index: 999999 !important; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border: 2px solid white !important;
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
  }
  .devaito-fab:hover { 
    transform: translateY(-2px) scale(1.05) !important; 
    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5), 0 6px 15px rgba(0,0,0,0.15) !important; 
  }
  .devaito-fab svg { 
    width: 28px !important; 
    height: 28px !important; 
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)) !important; 
    transition: transform 0.3s ease !important;
    fill: white !important;
  }
  .devaito-fab:hover svg { 
    transform: scale(1.1) !important; 
  }

  /* Modal */
  .devaito-modal-backdrop{ 
    position: fixed !important; 
    inset: 0 !important; 
    background: rgba(0,0,0,0.6) !important; 
    backdrop-filter: blur(4px) !important;
    display: none !important; 
    align-items: center !important; 
    justify-content: center !important; 
    z-index: 999998 !important; 
    animation: fadeIn 0.3s ease-out !important;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .devaito-modal{ 
    width: 550px; 
    max-width: 95%; 
    max-height: 90vh; 
    overflow: auto; 
    background: #fff; 
    border-radius: 16px; 
    padding: 0; 
    box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 10px 30px rgba(0,0,0,0.15); 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  @keyframes slideUp {
    from { 
      opacity: 0; 
      transform: translateY(30px) scale(0.95); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0) scale(1); 
    }
  }

  /* Modal Header */
  .devaito-modal-header {
    padding: 24px 24px 0 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #f1f5f9;
    margin-bottom: 20px;
  }
  .devaito-modal-title {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .devaito-modal-title::before {
    content: "üöö";
    font-size: 24px;
  }
  .devaito-close { 
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    cursor: pointer; 
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px; 
    color: #64748b;
    transition: all 0.2s ease;
  }
  .devaito-close:hover { 
    background: #fee2e2; 
    border-color: #fecaca;
    color: #dc2626; 
  }

  /* Modal Content */
  .devaito-modal-content {
    padding: 0 24px 24px 24px;
  }

  /* Checklist am√©lior√©e */
  .devaito-checklist{ 
    margin: 0 0 24px 0; 
    padding: 20px; 
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 12px; 
    border: 1px solid #e2e8f0;
    font-size: 14px; 
  }
  .devaito-checklist-title {
    font-weight: 700;
    font-size: 16px;
    color: #1e293b;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .devaito-checklist-title::before {
    content: "‚úì";
    background: #10b981;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }
  .devaito-check-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .devaito-check-item:last-child {
    border-bottom: none;
  }
  .devaito-check-label {
    font-weight: 500;
    color: #374151;
  }
  .devaito-status-ok{ 
    color: #059669; 
    font-weight: 600; 
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .devaito-status-ok::before {
    content: "‚úì";
    background: #10b981;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
  }
  .devaito-status-bad{ 
    color: #dc2626; 
    font-weight: 600; 
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .devaito-status-bad::before {
    content: "‚úó";
    background: #dc2626;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
  }

  /* Missing fields alert */
  .devaito-missing-fields {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
  }
  .devaito-missing-title {
    color: #dc2626;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .devaito-missing-title::before {
    content: "‚ö†";
    font-size: 16px;
  }
  .devaito-missing-list {
    color: #991b1b;
    font-size: 13px;
    margin-left: 22px;
  }
  .devaito-missing-item {
    margin-bottom: 2px;
  }

  /* Products */
  .devaito-prod{ 
    display: flex; 
    gap: 16px; 
    margin: 16px 0; 
    padding: 20px; 
    border-radius: 12px; 
    border: 1px solid #e5e7eb; 
    align-items: center; 
    background: #fafafa;
    transition: all 0.2s ease;
  }
  .devaito-prod:hover {
    border-color: #d1d5db;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  .devaito-prod img{ 
    width: 64px; 
    height: 64px; 
    object-fit: cover; 
    border-radius: 10px; 
    border: 1px solid #e5e7eb;
  }
  .devaito-prod-info {
    flex: 1;
  }
  .devaito-prod-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .devaito-prod-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 15px;
  }
  .devaito-prod-qty {
    background: #e0e7ff;
    color: #3730a3;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
  }

  /* Rates */
  .devaito-rates{ 
    margin-top: 12px; 
  }
  .devaito-rate-option{ 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    padding: 12px; 
    border-radius: 10px; 
    border: 2px solid #e5e7eb; 
    margin-bottom: 8px; 
    cursor: pointer; 
    transition: all 0.2s ease;
    background: white;
  }
  .devaito-rate-option:hover {
    border-color: #c7d2fe;
    background: #fafbff;
  }
  .devaito-rate-option.selected{ 
    border-color: #6366f1; 
    background: #f0f4ff;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
  }
  .devaito-rate-option input{ 
    margin: 0; 
    transform: scale(1.2);
  }
  .devaito-rate-info {
    flex: 1;
  }
  .devaito-rate-service {
    font-weight: 600;
    color: #374151;
    margin-bottom: 4px;
  }
  .devaito-rate-details {
    font-size: 12px;
    color: #6b7280;
  }
  .devaito-rate-price {
    min-width: 80px;
    text-align: right;
    font-weight: 700;
    font-size: 16px;
    color: #059669;
  }

  /* Footer */
  .devaito-footer{ 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-top: 24px; 
    gap: 16px; 
    padding-top: 20px;
    border-top: 1px solid #f1f5f9;
  }
  .devaito-totals {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .devaito-total-line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-width: 200px;
    font-size: 14px;
  }
  .devaito-total-label {
    color: #6b7280;
    font-weight: 500;
  }
  .devaito-total-value {
    font-weight: 600;
    color: #374151;
  }
  .devaito-btn{ 
    padding: 12px 24px; 
    border-radius: 10px; 
    border: 0; 
    cursor: pointer; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: white; 
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  .devaito-btn:hover:not([disabled]) {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }
  .devaito-btn[disabled]{ 
    opacity: 0.5; 
    cursor: not-allowed; 
    transform: none;
    box-shadow: none;
  }

  /* Loading state */
  .devaito-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #64748b;
  }
  .devaito-loading::after {
    content: "";
    width: 20px;
    height: 20px;
    margin-left: 10px;
    border: 3px solid #e2e8f0;
    border-radius: 50%;
    border-top-color: #667eea;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Scrollbar personnalis√©e */
  .devaito-modal::-webkit-scrollbar {
    width: 6px;
  }
  .devaito-modal::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  .devaito-modal::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }
  .devaito-modal::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
  `;
  document.head.appendChild(style);

  const fab = document.createElement('div');
  fab.className = 'devaito-fab';
  fab.title = 'Estimer les frais de livraison';
  fab.innerHTML = `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="#fff"/></svg>`;
  document.body.appendChild(fab);

  const backdrop = document.createElement('div');
  backdrop.className = 'devaito-modal-backdrop';
  backdrop.innerHTML = `
    <div class="devaito-modal" role="dialog" aria-modal="true" aria-label="Estimation frais livraison">
      <div class="devaito-modal-header">
        <h3 class="devaito-modal-title">Estimation de livraison</h3>
        <button class="devaito-close" title="Fermer">‚úï</button>
      </div>
      <div class="devaito-modal-content">
        <div class="devaito-checklist" id="devaito-checklist"></div>
        <div id="devaito-products-area"></div>
        <div class="devaito-footer">
          <div class="devaito-totals">
            <div class="devaito-total-line">
              <span class="devaito-total-label">Total produits:</span>
              <span class="devaito-total-value" id="devaito-products-total">0 ‚Ç¨</span>
            </div>
            <div class="devaito-total-line">
              <span class="devaito-total-label">Total livraison:</span>
              <span class="devaito-total-value" id="devaito-shipping-total">0 ‚Ç¨</span>
            </div>
            <div class="devaito-total-line" style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e2e8f0;">
              <span class="devaito-total-label" style="font-weight: 700;">Total g√©n√©ral:</span>
              <span class="devaito-total-value" id="devaito-grand-total" style="font-weight: 800; font-size: 16px; color: #059669;">0 ‚Ç¨</span>
            </div>
          </div>
          <div>
            <button class="devaito-btn" id="devaito-estimate-btn" disabled>Estimer les frais</button>
          </div>
        </div>
      </div>
    </div>`;
  document.body.appendChild(backdrop);

  // STATE
  let visible = false;
  let shopId = (typeof window.DEVAITO_SHOP_ID !== 'undefined') ? window.DEVAITO_SHOP_ID : null;
  let cart = parseCartFromStorage();
  let products = normalizeProductsFromCart(cart);
  let address = { name:'', street1:'', city:'', state:'', zip:'', country:'' };
  let latestRates = {};
  let selectedRateIndex = {};

  // OPEN / CLOSE
  const openModal = () => { 
    backdrop.style.display = 'flex'; 
    visible = true; 
    refreshUI(); 
  };
  
  const closeModal = () => { 
    backdrop.style.display = 'none'; 
    visible = false; 
  };
  
  fab.addEventListener('click', openModal);
  backdrop.addEventListener('click', (e)=>{ 
    if(e.target === backdrop) closeModal(); 
  });
  
  $('.devaito-close', backdrop).addEventListener('click', closeModal);

  // WATCH localStorage cross-tab
  window.addEventListener('storage', (e)=>{
    if(e.key === CART_LS_KEY){
      cart = parseCartFromStorage();
      products = normalizeProductsFromCart(cart);
      if(visible) refreshUI();
    }
  });
  
  // patch same-tab localStorage.setItem
  (function(){
    const original = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(k,v){
      original(k,v);
      try{ 
        window.dispatchEvent(new CustomEvent('devaito_localstorage_changed', { 
          detail:{ key:k, value:v } 
        })); 
      } catch(e){}
    };
  })();
  
  window.addEventListener('devaito_localstorage_changed', (e)=>{
    if(e.detail && e.detail.key === CART_LS_KEY){
      cart = parseCartFromStorage();
      products = normalizeProductsFromCart(cart);
      if(visible) refreshUI();
    }
  });

  // WIRE ADDRESS INPUTS (IDs provided in your markup)
  function wireFormFields(){
    const fullnameEl = $('#fullname');
    const phoneEl = $('#phone');
    const addressEl = $('#address');
    const postalEl = $('#postal-code');
    const countryEl = $('#country');
    const stateEl = $('#state');
    const cityEl = $('#city');

    if(fullnameEl){
      address.name = fullnameEl.value || '';
      fullnameEl.addEventListener('input', ()=>{ 
        address.name = fullnameEl.value || ''; 
        refreshUI(); 
      });
    }
    
    if(phoneEl){
      // phone is not used for rate calculation but keep it
      phoneEl.addEventListener('input', ()=> refreshUI());
    }
    
    if(addressEl){
      address.street1 = addressEl.value || '';
      addressEl.addEventListener('input', ()=>{ 
        address.street1 = addressEl.value || ''; 
        refreshUI(); 
      });
    }
    
    if(postalEl){
      address.zip = postalEl.value || '';
      postalEl.addEventListener('input', ()=>{ 
        address.zip = postalEl.value || ''; 
        refreshUI(); 
      });
    }
    
    if(countryEl){
      address.country = getSelectedCountryText() || countryEl.value || '';
      countryEl.addEventListener('change', ()=>{ 
        address.country = getSelectedCountryText() || countryEl.value || ''; 
        refreshUI(); 
      });
    }
    
    if(stateEl){
      address.state = getSelectedStateName() || stateEl.value || '';
      stateEl.addEventListener('change', ()=>{ 
        address.state = getSelectedStateName() || stateEl.value || ''; 
        refreshUI(); 
      });
    }
    
    if(cityEl){
      address.city = getSelectedCityText() || cityEl.value || '';
      cityEl.addEventListener('change', ()=>{ 
        address.city = getSelectedCityText() || cityEl.value || ''; 
        refreshUI(); 
      });
    }
  }
  
  wireFormFields();

function refreshChecklist() {
  const el = document.getElementById('devaito-checklist-body');
  if (!el) return;

  const shopOk = !!window.DEVAITO_SHOP_ID;
  const productsOk = cart && cart.length > 0;

  // Champs requis pour livraison
  const requiredFields = [
    ['Nom complet', document.getElementById('fullname')?.value],
    ['Email', document.getElementById('email')?.value],
    ['T√©l√©phone', document.getElementById('phone')?.value],
    ['Adresse', document.getElementById('address')?.value],
    ['Code postal', document.getElementById('postal-code')?.value],
    ['Pays', document.getElementById('country')?.value],
    ['√âtat', document.getElementById('state')?.value],
    ['Ville', document.getElementById('city')?.value],
  ];

  const missingFields = requiredFields.filter(([_, val]) => !val || val.trim() === '');
  const addressOk = missingFields.length === 0;

  let html = `
    <div class="devaito-checklist-title">V√©rifications des pr√©requis</div>
    <div class="devaito-check-item">
      <span class="devaito-check-label">Shop ID</span>
      <span class="${shopOk ? 'devaito-status-ok' : 'devaito-status-bad'}">
        ${shopOk ? window.DEVAITO_SHOP_ID : 'Manquant'}
      </span>
    </div>
    <div class="devaito-check-item">
      <span class="devaito-check-label">Produits dans le panier</span>
      <span class="${productsOk ? 'devaito-status-ok' : 'devaito-status-bad'}">
        ${productsOk ? `${cart.length} produit${cart.length > 1 ? 's' : ''}` : 'Vide'}
      </span>
    </div>
    <div class="devaito-check-item">
      <span class="devaito-check-label">Informations de livraison</span>
      <span class="${addressOk ? 'devaito-status-ok' : 'devaito-status-bad'}">
        ${addressOk ? 'Compl√®tes' : 'Incompl√®tes'}
      </span>
    </div>
  `;

  if (!addressOk) {
    html += `
      <div class="devaito-missing-fields">
        <div class="devaito-missing-title">Champs manquants :</div>
        <ul class="devaito-missing-list">
          ${missingFields.map(([label]) => `<li class="devaito-missing-item">‚Ä¢ ${label}</li>`).join('')}
        </ul>
      </div>
    `;
  }

  el.innerHTML = html;

  // Activation/d√©sactivation du bouton d'estimation
  const estimateBtn = document.getElementById('devaito-estimate-btn');
  if (estimateBtn) estimateBtn.disabled = !(shopOk && productsOk && addressOk);
}


  function renderProductsArea(){
    const area = $('#devaito-products-area', backdrop);
    area.innerHTML = '';
    
    if (products.length === 0) {
      area.innerHTML = `<div style="text-align: center; padding: 20px; color: #64748b;">Aucun produit dans le panier</div>`;
      return;
    }
    
    products.forEach(p=>{
      const wrapper = document.createElement('div');
      wrapper.className = 'devaito-prod';
      wrapper.dataset.productId = p.productId;
      wrapper.innerHTML = `
        <img src="${p.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyNEg0NEwyNiA0MEgyMlYyNFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" alt="${p.name || ''}" />
        <div class="devaito-prod-info">
          <div class="devaito-prod-header">
            <div class="devaito-prod-name">${p.name}</div>
            <div class="devaito-prod-qty">Qt√©: ${p.quantity}</div>
          </div>
          <div class="devaito-rates" id="devaito-rates-${p.productId}">
            <small style="color: #6b7280; font-style: italic;">Pas encore estim√©</small>
          </div>
        </div>
      `;
      area.appendChild(wrapper);
    });
    
    updateTotalsDisplay();
  }

  // Mettre √† jour l'affichage des totaux
    function updateTotalsDisplay() {
    const totalEl = document.getElementById('total-price');
    const taxEl = document.getElementById('tax-amount');
    const shippingEl = document.getElementById('shipping-amount');

    // V√©rification que les √©l√©ments existent
    if (totalEl) totalEl.textContent = calculateTotal().toFixed(2) + ' ‚Ç¨';
    if (taxEl) taxEl.textContent = calculateTax().toFixed(2) + ' ‚Ç¨';
    if (shippingEl) shippingEl.textContent = calculateShipping().toFixed(2) + ' ‚Ç¨';
    }


  // RATE PARSING: try many shapes (Shippo or custom)
  function extractRatePrice(rate){
    if(!rate) return 0;
    // common patterns
    if(typeof rate.amount === 'number') return rate.amount;
    if(typeof rate.amount === 'string' && !isNaN(parseFloat(rate.amount))) return parseFloat(rate.amount);
    if(rate.price && typeof rate.price === 'object'){
      if(typeof rate.price.amount === 'number') return rate.price.amount;
      if(typeof rate.price.amount === 'string' && !isNaN(parseFloat(rate.price.amount))) return parseFloat(rate.price.amount);
    }
    // Shippo style might be rate.amount_local / rate.amount
    if(typeof rate.amount_local === 'object' && rate.amount_local.amount) return Number(rate.amount_local.amount);
    if(rate.amount_total) return Number(rate.amount_total);
    if(rate.total) return Number(rate.total);
    return 0;
  }

  // NETWORK: post to API
  async function doEstimate(){
    if(!shopId) { 
      alert('Shop ID manquant'); 
      return; 
    }
    
    if(!products.length) { 
      alert('Aucun produit dans le panier'); 
      return; 
    }
    
    const payload = {
      shopId: String(shopId),
      toAddress: {
        name: address.name || '',
        street1: address.street1 || '',
        city: address.city || '',
        state: address.state || '',
        zip: address.zip || '',
        country: address.country || ''
      },
      products: products.map(p=> ({ 
        productId: Number(p.productId), 
        quantity: Number(p.quantity) 
      }))
    };

    const btn = $('#devaito-estimate-btn', backdrop);
    btn.disabled = true;
    const prevText = btn.textContent;
    btn.textContent = 'Estimation en cours...';

    // Show loading state for all products
    products.forEach(p => {
      const container = $(`#devaito-rates-${p.productId}`, backdrop);
      if(container) {
        container.innerHTML = '<div class="devaito-loading">Chargement des options...</div>';
      }
    });

    try {
      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (!resp.ok) {
        throw new Error(`HTTP error! status: ${resp.status}`);
      }
      
      const data = await resp.json();
      handleEstimateResponse(data);
    } catch(err){
      console.error('Estimation error', err);
      // Show error for all products
      products.forEach(p => {
        const container = $(`#devaito-rates-${p.productId}`, backdrop);
        if(container) {
          container.innerHTML = `<div style="color:#dc2626; background:#fee2e2; padding:8px; border-radius:6px; font-size:13px;">‚ùå Erreur: ${err.message || 'Impossible de r√©cup√©rer les tarifs'}</div>`;
        }
      });
    } finally {
      btn.disabled = false;
      btn.textContent = prevText || 'Estimer les frais';
    }
  }

  function handleEstimateResponse(data){
    latestRates = {};
    selectedRateIndex = {};
    
    if(!data || !Array.isArray(data.products)){
      alert('R√©ponse serveur inattendue');
      return;
    }
    
    data.products.forEach(pr=>{
      const pid = Number(pr.productId);
      const rates = Array.isArray(pr.rates) ? pr.rates : [];
      latestRates[pid] = rates;
      selectedRateIndex[pid] = rates.length ? 0 : -1;
      renderRatesForProduct(pid, rates, pr.error);
    });
    
    updateTotalsDisplay();
  }

  function renderRatesForProduct(productId, rates, error){
    const container = $(`#devaito-rates-${productId}`, backdrop);
    if(!container) return;
    container.innerHTML = '';
    
    if(error){
      container.innerHTML = `<div style="color:#dc2626; background:#fee2e2; padding:8px; border-radius:6px; font-size:13px;">‚ùå Erreur: ${error}</div>`;
      return;
    }
    
    if(!rates || rates.length === 0){
      container.innerHTML = `<div style="color:#6b7280; font-style:italic; text-align:center; padding:8px;">üì¶ Aucune option de livraison trouv√©e</div>`;
      return;
    }
    
    const list = document.createElement('div');
    rates.forEach((r, idx)=>{
      const price = extractRatePrice(r);
      const name = r.service || r.provider || r.carrier || r.name || `Option ${idx+1}`;
      const opt = document.createElement('label');
      opt.className = 'devaito-rate-option' + ((selectedRateIndex[productId]===idx) ? ' selected' : '');
      opt.innerHTML = `
        <input type="radio" name="devaito-rate-${productId}" value="${idx}" ${selectedRateIndex[productId]===idx ? 'checked' : ''} />
        <div class="devaito-rate-info">
          <div class="devaito-rate-service">${name}</div>
          <div class="devaito-rate-details">
            ${r.estimated_days ? `‚è±Ô∏è ${r.estimated_days} jour${r.estimated_days > 1 ? 's' : ''}` : ''}
            ${r.notes ? ` ‚Ä¢ ${r.notes}` : ''}
          </div>
        </div>
        <div class="devaito-rate-price">${price ? formatMoney(price) : 'N/A'}</div>
      `;
      const input = opt.querySelector('input');
      input.addEventListener('change', ()=>{
        selectedRateIndex[productId] = idx;
        $all(`#devaito-rates-${productId} .devaito-rate-option`).forEach((el, i)=>{
          el.classList.toggle('selected', i===idx);
        });
        updateTotalsDisplay();
      });
      opt.addEventListener('click', ()=> input.checked = true);
      list.appendChild(opt);
    });
    container.appendChild(list);
  }

  // WIRE estimate button
  $('#devaito-estimate-btn', backdrop).addEventListener('click', doEstimate);

  // Fonction principale pour rafra√Æchir l'UI
function refreshUI() {
  // V√©rifier que le container des produits existe
  const productsArea = document.getElementById('products-area');
  if (!productsArea) return;

  renderProductsArea(productsArea);
  updateTotalsDisplay();
}

  // INITIAL hydrate and watchers
  cart = parseCartFromStorage();
  products = normalizeProductsFromCart(cart);
  refreshUI();

  // light interval to detect cart changes if other scripts modify without storage events
  setInterval(()=>{
    const newCart = parseCartFromStorage();
    const newProducts = normalizeProductsFromCart(newCart);
    if(JSON.stringify(newProducts) !== JSON.stringify(products)){
      cart = newCart;
      products = newProducts;
      if(visible) refreshUI();
    }
  }, 2000);

  // expose API for page scripts
  window.DEVAITO_shipping_widget = {
    open: openModal,
    close: closeModal,
    recheck: refreshUI,
    estimateNow: doEstimate
  };

  // S'assurer que le DOM est charg√© avant d'ex√©cuter
document.addEventListener('DOMContentLoaded', () => {
  refreshUI();
});

})();
</script>