"use strict";(()=>{typeof window.devaitoInitialized>"u"&&(window.devaitoInitialized=!0,(function(){let j={API_BASE:"http://localhost:3000/api",DEBUG:!0},n={info:(...s)=>console.log("[DEV]",...s),error:(...s)=>console.error("[DEV-ERR]",...s),debug:(...s)=>j.DEBUG&&console.log("[DEV-DBG]",...s)};n.info("Initialisation du widget");function Y(){return window.location.href.includes("/admin/builder")}if(Y()){n.info("Mode Builder d\xE9tect\xE9 : script du widget non ex\xE9cut\xE9.");return}if(!document.getElementById("devaito-widget-styles")){let s=document.createElement("style");s.id="devaito-widget-styles",s.textContent=`
        .devaito-card-widget { 
          transition: all 0.3s ease; 
        }
        .devaito-card-widget:hover { 
          box-shadow: 0 8px 25px rgba(0,208,132,0.15) !important; 
        }
        .devaito-btn-primary { 
          transition: all 0.3s ease; 
        }
        .devaito-btn-primary:hover { 
          background: #00b870 !important; 
          transform: translateY(-1px); 
        }
        .devaito-input-field { 
          transition: border-color 0.2s ease; 
        }
        .devaito-input-field:focus { 
          border-color: #00d084 !important; 
          outline: none; 
          box-shadow: 0 0 0 2px rgba(0,208,132,0.1); 
        }
        .devaito-rate-card { 
          transition: all 0.2s ease; 
        }
        .devaito-rate-card:hover { 
          border-color: #00d084 !important; 
          transform: translateY(-2px); 
          box-shadow: 0 4px 15px rgba(0,208,132,0.1); 
        }
        .devaito-toggle-container { 
          transition: all 0.2s ease; 
        }
        .devaito-toggle-container:hover { 
          background: #f0f9ff !important; 
        }
        @media (min-width: 550px) {
          .devaito-grid-responsive {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 12px !important;
          }
        }
      `,document.head.appendChild(s)}function W(){let s=document.getElementById("devaito-widget");if(!s){n.error("Container non trouv\xE9");return}if(s.querySelector("#devaito-toggle")){n.info("Widget d\xE9j\xE0 initialis\xE9");return}let P=s.getAttribute("data-shop-id");if(!P){n.error("data-shop-id manquant");return}n.info(`Boutique: ${P}`);var E=document.createElement("div");E.className="devaito-card-widget",E.style.cssText="background: white; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; overflow: hidden; margin: 20px auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;";var B=document.createElement("div");B.style.cssText="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom: 1px solid #e5e7eb;";var v=document.createElement("label");v.className="devaito-toggle-container",v.htmlFor="devaito-toggle-checkbox",v.style.cssText="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px; border-radius: 8px; background: transparent;";var k=document.createElement("div");k.style.cssText="display: flex; align-items: center; gap: 12px;";var H=document.createElement("div");H.innerHTML="\u{1F4E6}",H.style.cssText="font-size: 20px;";var N=document.createElement("div"),O=document.createElement("div");O.textContent="Estimation livraison",O.style.cssText="font-weight: 600; color: #1f2937; font-size: 16px; line-height: 1.2;";var _=document.createElement("div");_.textContent="Calculez vos frais de port",_.style.cssText="font-size: 13px; color: #6b7280; margin-top: 2px;",N.appendChild(O),N.appendChild(_),k.appendChild(H),k.appendChild(N);var A=document.createElement("div");A.style.cssText="position: relative; width: 48px; height: 24px;";var C=document.createElement("input");C.type="checkbox",C.id="devaito-toggle-checkbox",C.style.cssText="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2;";var w=document.createElement("div");w.style.cssText="width: 48px; height: 24px; background: #d1d5db; border-radius: 12px; position: relative; transition: all 0.3s ease;";var z=document.createElement("div");z.style.cssText="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);",w.appendChild(z),A.appendChild(C),A.appendChild(w),v.appendChild(k),v.appendChild(A),B.appendChild(v);var u=document.createElement("div");u.id="devaito-content",u.style.cssText="display: none; padding: 24px; background: white;";var S=document.createElement("div");S.style.cssText="margin-bottom: 20px;";var F=document.createElement("h4");F.textContent="Produits",F.style.cssText="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #374151;";var y=document.createElement("div");y.id="devaito-products",y.style.cssText="margin-bottom: 20px;",S.appendChild(F),S.appendChild(y);var $=document.createElement("div");$.style.cssText="margin-bottom: 20px;";var G=document.createElement("h4");G.textContent="Adresse de livraison",G.style.cssText="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: #374151;";var L=document.createElement("div");L.className="devaito-grid-responsive",L.style.cssText="display: flex; flex-direction: column; gap: 12px;";var K=[{name:"name",placeholder:"Nom complet",type:"text",autocomplete:"name"},{name:"street",placeholder:"Adresse",type:"text",autocomplete:"street-address"},{name:"city",placeholder:"Ville",type:"text",autocomplete:"address-level2"},{name:"state",placeholder:"R\xE9gion",type:"text",autocomplete:"address-level1"},{name:"zip",placeholder:"Code postal",type:"text",autocomplete:"postal-code"},{name:"phone",placeholder:"T\xE9l\xE9phone",type:"tel",autocomplete:"tel"},{name:"email",placeholder:"Email",type:"email",autocomplete:"email"}],f=[];K.forEach(function(t){var e=document.createElement("input");e.type=t.type,e.placeholder=t.placeholder,e.name=t.name,e.autocomplete=t.autocomplete,e.className="devaito-input-field",e.style.cssText="width: 100%; padding: 12px 16px; border: 1.5px solid #d1d5db; border-radius: 8px; font-size: 14px; background: #f9fafb; box-sizing: border-box;",t.name==="name"&&(e.value="Jean Dupont"),t.name==="street"&&(e.value="123 Rue de la Paix"),t.name==="city"&&(e.value="Paris"),t.name==="state"&&(e.value="\xCEle-de-France"),t.name==="zip"&&(e.value="75001"),t.name==="phone"&&(e.value="+33 1 23 45 67 89"),t.name==="email"&&(e.value="jean.dupont@exemple.com"),L.appendChild(e),f.push(e)}),$.appendChild(G),$.appendChild(L);var o=document.createElement("button");o.id="devaito-estimate",o.className="devaito-btn-primary",o.innerHTML="\u2728 Estimer les frais de port",o.style.cssText="width: 100%; padding: 14px 20px; border-radius: 10px; border: none; background: #00d084; color: white; font-weight: 600; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;";var b=document.createElement("div");b.id="devaito-error",b.style.cssText="color: #dc2626; margin-top: 12px; font-size: 14px; padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; display: none;";var x=document.createElement("div");x.id="devaito-results",x.style.cssText="margin-top: 20px;",u.appendChild(S),u.appendChild($),u.appendChild(o),u.appendChild(b),u.appendChild(x),E.appendChild(B),E.appendChild(u),s.appendChild(E);var g=[];C.onchange=function(){this.checked?(u.style.display="block",w.style.background="#00d084",z.style.transform="translateX(24px)",n.debug("Widget activ\xE9")):(u.style.display="none",w.style.background="#d1d5db",z.style.transform="translateX(0)",n.debug("Widget d\xE9sactiv\xE9"))};function Z(){var t=window.location.pathname.toLowerCase();if(n.info(`Page: ${t}`),t.includes("/checkout")){let m=function(r){return r.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"-").replace(/[^\w-]+/g,"").replace(/--+/g,"-").replace(/^-+|-+$/g,"")};var i=m;n.info("Page checkout d\xE9tect\xE9e");var e=[];return document.querySelectorAll(".order-item .item-name").forEach(r=>{if(r){let l=r.textContent.trim(),c=m(l);c="products"+c,c&&e.indexOf(c)===-1&&(e.push(c),n.debug(`Slug checkout d\xE9tect\xE9: ${c}`))}}),n.info(`Slugs checkout trouv\xE9s: ${e.length}`),e}if(t.includes("/cart")||t.includes("/panier")){n.info("Page panier d\xE9tect\xE9e");var e=[];return document.querySelectorAll('a[href*="/product/"], a[href*="/products/"], [data-product-slug]').forEach(function(r){var l=r.href&&r.href.split("/product/")[1]?.split("/")[0]||r.href&&r.href.split("/products/")[1]?.split("/")[0]||r.getAttribute("data-product-slug");l&&e.indexOf(l)===-1&&(e.push(l),n.debug(`Slug: ${l}`))}),n.info(`Slugs trouv\xE9s: ${e.length}`),e}var d=t.split("/product/")[1]?.split("/")[0]||t.split("/products/")[1]?.split("/")[0];return d?n.info(`Page produit, slug: ${d}`):n.info("Aucun slug d\xE9tect\xE9"),d?[d]:[]}async function Q(){try{var t=Z();t.length||(t=["product-demo"],n.info("Utilisation du slug de d\xE9mo")),n.info(`Envoi requ\xEAte avec ${t.length} slugs`);var e=await fetch(j.API_BASE+"/get_shop_by_id",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shopId:P,slugs:t})});if(!e.ok)throw new Error(`Erreur API: ${e.status}`);var d=await e.json();n.info("R\xE9ponse API re\xE7ue"),g=d.products.map(function(i){return{name:i.name,quantity:i.quantity||1,maxQuantity:i.quantity||99,dimensions:i.dimensions,fromAddress:i.shippingAddress}}),y.innerHTML="",g.length===0?(n.info("Aucun produit dans la r\xE9ponse"),y.innerHTML="<p style='color:#9ca3af; text-align:center; padding:12px;'>Aucun produit disponible"):(n.info(`${g.length} produits charg\xE9s`),g.forEach(function(i,m){var r=document.createElement("div");r.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px;";var l=document.createElement("div");l.style.cssText="flex-grow: 1; margin-right: 12px;";var c=document.createElement("div");c.textContent=i.name,c.style.cssText="font-weight: 500; color: #374151; font-size: 14px;";var a=document.createElement("div");a.textContent=`${i.dimensions.length}\xD7${i.dimensions.width}\xD7${i.dimensions.height}cm`,a.style.cssText="font-size: 12px; color: #6b7280; margin-top: 2px;",l.appendChild(c),l.appendChild(a);var p=document.createElement("input");p.type="number",p.value=i.quantity,p.min=1,p.max=i.maxQuantity,p.dataset.index=m,p.style.cssText="width: 60px; padding: 8px; border: 1.5px solid #d1d5db; border-radius: 6px; text-align: center; font-size: 14px;",r.appendChild(l),r.appendChild(p),y.appendChild(r)}))}catch(i){I("Erreur de chargement des produits"),n.error("Erreur fetchShopData",i.message)}}function X(){return{name:f[0].value||"",street1:f[1].value||"",city:f[2].value||"",state:f[3].value||"",zip:f[4].value||"",phone:f[5].value||"",email:f[6].value||"",country:"France"}}function ee(){var t={};g.forEach(function(d){var i=JSON.stringify(d.fromAddress);t[i]||(t[i]={from:d.fromAddress,parcels:[]});for(var m=0;m<d.quantity;m++)t[i].parcels.push(d.dimensions)});var e=[];return Object.keys(t).forEach(function(d){e.push({from:t[d].from,to:X(),parcels:t[d].parcels})}),n.info(`${e.length} groupes d'exp\xE9dition pr\xE9par\xE9s`),e}function I(t){b.textContent=t,b.style.display="block"}function te(){b.style.display="none"}o.onclick=async function(){te(),x.innerHTML="";var t=o.innerHTML;o.innerHTML="\u23F3 Calcul en cours...",o.disabled=!0,o.style.background="#9ca3af",n.info("D\xE9but estimation"),u.querySelectorAll("input[type=number]").forEach(function(a){var p=parseInt(a.dataset.index);g[p].quantity=Math.max(1,parseInt(a.value)||1)});var e=X();if(n.debug("Adresse",e),!e.street1||!e.city||!e.zip||!e.email){I("\u26A0\uFE0F Veuillez compl\xE9ter tous les champs obligatoires"),o.innerHTML=t,o.disabled=!1,o.style.background="#00d084",n.info("Champs incomplets");return}if(await Q(),!g.length){I("\u274C Aucun produit disponible pour l'estimation"),o.innerHTML=t,o.disabled=!1,o.style.background="#00d084",n.info("Aucun produit");return}var d=ee();n.debug("Requ\xEAtes pr\xE9par\xE9es");try{var i=[];for(var m of d){n.info(`Envoi requ\xEAte pour ${m.parcels.length} colis`);var r=await fetch(j.API_BASE+"/getRates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!r.ok)throw new Error(`Erreur: ${r.status}`);var l=await r.json();n.info(`${l.length} options re\xE7ues`),i.push(...l)}if(x.innerHTML="",i.length===0)x.innerHTML="<div style='text-align:center; color:#6b7280; padding:20px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;'>\u{1F4ED} Aucune option de livraison disponible",n.info("Aucune option de livraison");else{var c=document.createElement("h4");c.textContent="Options de livraison",c.style.cssText="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #374151;",x.appendChild(c),i.sort((a,p)=>parseFloat(a.price)-parseFloat(p.price)),i.forEach(function(a,p){var T=document.createElement("div");T.className="devaito-rate-card",T.style.cssText="display: flex; align-items: center; justify-content: space-between; padding: 16px; margin-bottom: 12px; background: white; border-radius: 10px; border: 1.5px solid #e5e7eb; cursor: pointer;";var q=document.createElement("div");q.style.cssText="display: flex; align-items: center; gap: 12px; flex: 1;";var h=document.createElement("img");a.img?(h.src=a.img,h.alt=a.carrier,h.style.cssText="width: 40px; height: 40px; object-fit: contain; border-radius: 6px; background: #f9fafb;"):(h=document.createElement("div"),h.textContent="\u{1F69A}",h.style.cssText="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 6px; font-size: 20px;");var M=document.createElement("div");M.style.cssText="flex: 1;";var R=document.createElement("div");R.textContent=`${a.carrier} - ${a.service}`,R.style.cssText="font-weight: 600; color: #374151; font-size: 14px; line-height: 1.3;";var V=document.createElement("div");a.estimated_days&&(V.textContent=`Livraison estim\xE9e: ${a.estimated_days} jour${a.estimated_days>1?"s":""}`,V.style.cssText="font-size: 12px; color: #6b7280; margin-top: 2px;"),M.appendChild(R),a.estimated_days&&M.appendChild(V);var D=document.createElement("div");D.style.cssText="text-align: right;";var J=document.createElement("div");J.textContent=`${a.price} ${a.currency}`,J.style.cssText="font-weight: 700; font-size: 16px; color: #00d084;";var U=document.createElement("div");p===0&&(U.textContent="Le moins cher",U.style.cssText="font-size: 11px; color: #059669; background: #d1fae5; padding: 2px 8px; border-radius: 12px; margin-top: 4px; display: inline-block;"),D.appendChild(J),p===0&&D.appendChild(U),q.appendChild(h),q.appendChild(M),T.appendChild(q),T.appendChild(D),x.appendChild(T)}),n.info(`${i.length} options affich\xE9es`)}}catch(a){I("\u274C Erreur lors de l'estimation des frais de port"),n.error("Erreur estimation",a.message)}finally{o.innerHTML=t,o.disabled=!1,o.style.background="#00d084"}},n.info("Chargement initial"),Q()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",W):W()})());})();
